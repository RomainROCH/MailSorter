# Security Vulnerability Scan Workflow
# Runs pip-audit and safety checks on Python dependencies
# SEC-004: CI vulnerability scanning

name: Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-audit:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety
          pip install -r backend/requirements.txt

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          echo "## Pip Audit Results" >> $GITHUB_STEP_SUMMARY
          pip-audit --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
          pip-audit --strict --desc on

      - name: Run safety check
        id: safety
        continue-on-error: true
        run: |
          echo "## Safety Check Results" >> $GITHUB_STEP_SUMMARY
          safety check --full-report >> $GITHUB_STEP_SUMMARY 2>&1 || true
          safety check

      - name: Check for critical vulnerabilities
        if: steps.pip-audit.outcome == 'failure' || steps.safety.outcome == 'failure'
        run: |
          echo "::warning::Security vulnerabilities detected in dependencies"
          echo "Please review the audit results and update vulnerable packages"
          # Don't fail the build for now, just warn
          # exit 1

  static-analysis:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run Bandit security linter
        run: |
          echo "## Bandit Security Analysis" >> $GITHUB_STEP_SUMMARY
          bandit -r backend/ -f markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
          bandit -r backend/ -ll -ii

  extension-audit:
    name: Extension Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Audit manifest.json permissions
        run: |
          echo "## Extension Permissions Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract and display permissions
          echo "### Requested Permissions" >> $GITHUB_STEP_SUMMARY
          jq -r '.permissions[]? // empty' extension/manifest.json 2>/dev/null | while read perm; do
            echo "- \`$perm\`" >> $GITHUB_STEP_SUMMARY
          done
          
          # Check for overly broad permissions
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Permission Analysis" >> $GITHUB_STEP_SUMMARY
          
          MANIFEST="extension/manifest.json"
          
          # Check for dangerous permissions
          if grep -q '"<all_urls>"' "$MANIFEST"; then
            echo "⚠️ WARNING: Extension requests access to all URLs" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q '"nativeMessaging"' "$MANIFEST"; then
            echo "ℹ️ INFO: Extension uses native messaging (required for backend communication)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q '"storage"' "$MANIFEST"; then
            echo "ℹ️ INFO: Extension uses local storage" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Permission audit complete" >> $GITHUB_STEP_SUMMARY

      - name: Check Content Security Policy
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Content Security Policy" >> $GITHUB_STEP_SUMMARY
          
          MANIFEST="extension/manifest.json"
          
          if jq -e '.content_security_policy' "$MANIFEST" > /dev/null 2>&1; then
            CSP=$(jq -r '.content_security_policy' "$MANIFEST")
            echo "CSP defined: \`$CSP\`" >> $GITHUB_STEP_SUMMARY
            
            # Check for unsafe-inline
            if echo "$CSP" | grep -q "unsafe-inline"; then
              echo "⚠️ WARNING: CSP contains 'unsafe-inline'" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for unsafe-eval
            if echo "$CSP" | grep -q "unsafe-eval"; then
              echo "⚠️ WARNING: CSP contains 'unsafe-eval'" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ No explicit CSP defined (using browser defaults)" >> $GITHUB_STEP_SUMMARY
          fi
